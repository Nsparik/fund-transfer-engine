# ═══════════════════════════════════════════════════════════════════════════════
# Apache VirtualHost — Fund Transfer Engine
#
# Architecture:
#   Browser/Client → Apache:80 → mod_proxy_fcgi → PHP-FPM:9000
#
# Apache handles HTTP (routing, headers, access control).
# PHP-FPM handles PHP execution (as appuser, not root).
# This separation is intentional — PHP never touches the network directly.
# ═══════════════════════════════════════════════════════════════════════════════

ServerName localhost

# ── Global Security ───────────────────────────────────────────────────────────
# These directives must be at server level, not inside VirtualHost.
# Hide Apache version from error pages and Server header.
ServerTokens Prod
ServerSignature Off

<VirtualHost *:80>
    # Symfony's public/ directory is the ONLY document root.
    # Nothing outside public/ is ever directly accessible via HTTP.
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        # Required for Symfony's front controller (index.php) routing
        AllowOverride None
        Require all granted

        # Symfony front controller pattern:
        # All requests → index.php unless a real file/directory exists.
        FallbackResource /index.php
    </Directory>

    # ── PHP-FPM Proxy ─────────────────────────────────────────────────────────
    # Forward all .php requests to PHP-FPM container on the internal network.
    # 'php' resolves to the fund_php container via Docker DNS on fund_internal.
    <FilesMatch \.php$>
        SetHandler  "proxy:fcgi://php:9000"
    </FilesMatch>

    # ── Security Headers ──────────────────────────────────────────────────────
    # Prevent MIME-type sniffing
    Header always set X-Content-Type-Options "nosniff"
    # Prevent clickjacking
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"

    # ── Logging ───────────────────────────────────────────────────────────────
    # Route to Docker stdout/stderr for `docker compose logs apache`
    ErrorLog  /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
